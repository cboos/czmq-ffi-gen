#!/bin/sh -x
# vim: ft=sh
set -e
pwd

submodule="vendor/czmq"

# read submodule URL from .gitmodules and register it in .git/config
# NOTE: this is probably always needed, because for every build the
# czmq-ffi-gen repo is cloned anew.
# NOTE: This is idempotent.
git submodule init -- $submodule

# useful output
git submodule status -- $submodule

# TEST whether "grep ... '^.'" works as expected. On OSX, it doesn't. On OSX,
# it matches every character, not only the first of each line. WTF
git submodule status -- $submodule | grep -o '^.'

# check if vendor/ directory cache is up to date
status="`git submodule status -- $submodule | sed -e 's/\(.\).*/\1/'`"
# status is one of:
#   " " (up-to-date)
#   "-" (not initialized)
#   "+" (wrong commit)
#   "U" (merge conflicts)

case "$status" in
" ")
	echo "Git submodule $submodule from cache is still up-to-date."
	cd $submodule
	echo "No compilation should be needed."
	;;
"+")
	echo "Git submodule $submodule from cache is needs to be updated."
	git submodule update -- $submodule
	cd $submodule
	./autogen.sh
	./configure
	make
	;;
*)
	echo "Git submodule $submodule is in bad state: '$state'" >&2
	exit 1
	;;
esac

sudo make install
sudo ldconfig
